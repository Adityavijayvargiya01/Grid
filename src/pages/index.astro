---
import BaseLayout from "~/layouts/BaseLayout.astro";
import { ImageScaleSlider } from "~/components/ImageScaleSlider";
import { ThemeToggle } from "~/components/ThemeToggle";
import { MotionGallery } from "~/components/MotionGallery";
import "@fancyapps/ui/dist/fancybox/fancybox.css";

import { createClient } from "@supabase/supabase-js";

const SUPABASE_URL = import.meta.env.SUPABASE_URL;
const SUPABASE_ANON_KEY = import.meta.env.SUPABASE_ANON_KEY;

if (!SUPABASE_URL) throw new Error("SUPABASE_URL is not set");
if (!SUPABASE_ANON_KEY) throw new Error("SUPABASE_ANON_KEY is not set");

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: false, autoRefreshToken: false },
});

type WallpaperRow = {
  id: string;
  bucket_path: string;
  width: number;
  height: number;
  blur_data_url: string | null;
  created_at: string;
};

const { data, error } = await supabase
  .from("wallpapers")
  .select("id,bucket_path,width,height,blur_data_url,created_at")
  .order("created_at", { ascending: false });

if (error) throw error;

function toPublicStorageUrl(bucketPath: string) {
  const encoded = bucketPath
    .split("/")
    .map((segment) => encodeURIComponent(segment))
    .join("/");
  return `${SUPABASE_URL}/storage/v1/object/public/wallpapers/${encoded}`;
}

const wallpapers = ((data ?? []) as WallpaperRow[]).map((row) => ({
  id: row.id,
  href: toPublicStorageUrl(row.bucket_path),
  src: toPublicStorageUrl(row.bucket_path),
  width: row.width,
  height: row.height,
  blurDataUrl: row.blur_data_url,
}));
---

<BaseLayout
  title="Grid"
  description="A minimal, single-page photo gallery for Astro."
>
  <div class="topbar">
    <div class="topbar-center">
      <ImageScaleSlider client:load />
    </div>
    <div class="topbar-right">
      <ThemeToggle client:load />
    </div>
  </div>
  <MotionGallery wallpapers={wallpapers} client:load />
</BaseLayout>

<style>
  .topbar {
    position: sticky;
    top: 0;
    z-index: 10;
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    padding: 18px 12px 8px;
  }

  .topbar-center {
    width: min(520px, calc(100vw - 24px - 56px));
    grid-column: 2;
  }

  .topbar-right {
    grid-column: 3;
    justify-self: end;
  }
</style>

<style is:global>
  .justified-gallery {
    --padding: max(1.5vw, 12px);

    --space: max(1.5vw, 12px);
    --min-height: var(--gallery-min-height, clamp(200px, 20vw, 400px));

    padding: var(--padding);
    display: flex;
    flex-wrap: wrap;
    gap: var(--space);

    a {
      flex-grow: calc(var(--width) * (100000 / var(--height)));
      flex-basis: calc(var(--min-height) * (var(--width) / var(--height)));
      aspect-ratio: var(--width) / var(--height);
      overflow: hidden;
      opacity: 1;
      transition: all 0.05s ease-in-out;
    }

    a img {
      display: block;
      object-fit: cover;
      height: 100%;
      width: 100%;
    }

    a:focus-visible {
      outline: 3px solid var(--outline);
      outline-offset: 2px;
      transform: scale(1.05);
      z-index: 1;
      border-radius: 2px;
      box-shadow: 0 2px 4px 2px rgba(0, 0, 0, 0.1);
    }

    a.hidden {
      transition: opacity 0.4s ease-in-out;
      opacity: 0;
    }

    &::after {
      content: " ";
      flex-grow: 1000000000;
    }
  }
</style>
