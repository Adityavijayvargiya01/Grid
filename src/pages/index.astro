---
import { ImageScaleSlider } from "~/components/ImageScaleSlider";
import { MotionGallery } from "~/components/MotionGallery";
import { ThemeToggle } from "~/components/ThemeToggle";
import BaseLayout from "~/layouts/BaseLayout.astro";
import "@fancyapps/ui/dist/fancybox/fancybox.css";

import fs from "node:fs";
import path from "node:path";
import sharp from "sharp";

const gridDir = path.join(process.cwd(), "public", "Grid");
const imageExtensions = [".jpg", ".jpeg", ".png", ".webp", ".gif", ".avif", ".heic", ".tiff"];

const files = fs.readdirSync(gridDir).filter((file) => {
  const ext = path.extname(file).toLowerCase();
  return imageExtensions.includes(ext);
});

const wallpapers = await Promise.all(
  files.map(async (file, index) => {
    const filePath = path.join(gridDir, file);
    const publicPath = `/Grid/${encodeURIComponent(file)}`;
    
    let width = 1920;
    let height = 1080;
    let blurDataUrl = null;
    
    try {
      const metadata = await sharp(filePath).metadata();
      width = metadata.width || 1920;
      height = metadata.height || 1080;
      
      const tiny = await sharp(filePath)
        .resize({ width: 24, withoutEnlargement: true })
        .blur(8)
        .jpeg({ quality: 40, mozjpeg: true })
        .toBuffer();
      
      blurDataUrl = `data:image/jpeg;base64,${tiny.toString("base64")}`;
    } catch (err) {
      console.warn(`Failed to process ${file}:`, err);
    }
    
    return {
      id: `${index}-${file}`,
      href: publicPath,
      src: publicPath,
      width,
      height,
      blurDataUrl,
    };
  })
);

const preloadWallpapers = wallpapers.slice(0, 30);
---

<BaseLayout
  title="Grid"
  description="A minimal, single-page photo gallery for Astro."
>
  <link rel="preconnect" href="https://fonts.googleapis.com" slot="head" />
  <link
    rel="preconnect"
    href="https://fonts.gstatic.com"
    crossorigin
    slot="head"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&display=swap"
    rel="stylesheet"
    slot="head"
  />
  {
    preloadWallpapers.map((img) => (
      <link
        slot="head"
        rel="preload"
        as="image"
        href={img.src}
        fetchpriority="high"
      />
    ))
  }
  <div class="topbar">
    <div class="topbar-center">
      <ImageScaleSlider client:load />
    </div>
    <div class="topbar-right">
      <ThemeToggle client:load />
    </div>
  </div>
  <MotionGallery wallpapers={wallpapers} client:load />
</BaseLayout>

<style>
  .topbar {
    position: sticky;
    top: 0;
    z-index: 10;
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    padding: 18px 12px 8px;
  }

  .topbar-center {
    width: min(520px, calc(100vw - 24px - 56px));
    grid-column: 2;
  }

  .topbar-right {
    grid-column: 3;
    justify-self: end;
  }
</style>

<style is:global>
  .justified-gallery {
    --padding: max(1.5vw, 12px);

    --space: max(1.5vw, 12px);
    --min-height: var(--gallery-min-height, clamp(200px, 20vw, 400px));

    padding: var(--padding);
    display: flex;
    flex-wrap: wrap;
    gap: var(--space);

    a {
      flex-grow: calc(var(--width) * (100000 / var(--height)));
      flex-basis: calc(var(--min-height) * (var(--width) / var(--height)));
      aspect-ratio: var(--width) / var(--height);
      overflow: hidden;
      opacity: 1;
      transition: all 0.05s ease-in-out;
    }

    a img {
      display: block;
      object-fit: cover;
      height: 100%;
      width: 100%;
    }

    a:focus-visible {
      outline: 3px solid var(--outline);
      outline-offset: 2px;
      transform: scale(1.05);
      z-index: 1;
      border-radius: 2px;
      box-shadow: 0 2px 4px 2px rgba(0, 0, 0, 0.1);
    }

    a.gallery-item {
      position: relative;
    }

    .image-info {
      position: absolute;
      bottom: 8px;
      right: 8px;
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 13px;
      line-height: 1.4;
      pointer-events: none;
      z-index: 2;
      backdrop-filter: blur(5px);
      font-family: "Google Sans", sans-serif;
      background-color: rgba(0, 0, 0, 0.1);
    }
    
    .image-info:hover {
      background-color: rgba(0, 0, 0, 0.4);
    }

    .image-download-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      color: white;
      padding: 8px;
      border-radius: 20px;
      cursor: pointer;
      z-index: 2;
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
      background-color: rgba(0, 0, 0, 0.1);
    }

    .image-download-btn:hover {
      background-color: rgba(0, 0, 0, 0.4);
    }

    .image-info-dimensions {
      font-weight: 500;
      white-space: nowrap;
    }

    .image-info-size {
      font-weight: 400;
      opacity: 0.9;
      margin-top: 2px;
      white-space: nowrap;
    }

    a.hidden {
      transition: opacity 0.4s ease-in-out;
      opacity: 0;
    }

    &::after {
      content: " ";
      flex-grow: 1000000000;
    }
  }
</style>
